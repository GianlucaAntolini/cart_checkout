@using YourNamespace.Models;
@model Product
@{
    ViewBag.Title = "Cart";
    // Get the products and order from the viewbag if it is not null
   var products = ViewBag.Products as List<Product>;
    var order = ViewBag.Order as Order;
}


    <div class="page-container">
        <h3>Carrello</h3>
        <section class="cart-items">
            <table class="cart-items">
                <thead>
                    <tr>
                        <th></th>
                        <th>Prodotto</th>
                        <th>Prezzo</th>
                        <th>Quantit√†</th>
                        <th>Totale</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var orderProduct in order.OrderProducts)
                    {
                        <tr>
                            <td class="cart-action tac">
                               <form asp-action="RemoveProduct" method="post">
                                <input type="hidden" name="orderProductId" value="@orderProduct.Id" />
                                <button type="submit" class="cart-remove">X</button>
                            </form>
                            </td>
                            <td class="cart-item">
                                <img src="~/img/products/@(orderProduct.ProductId).png" alt="Product Image"  class="productImage"/>
                                @orderProduct.Product.Name</td>
                            <td class="cart-price tar">@orderProduct.Product.Price</td>
                            <td class="cart-action cart-quantity tac">
                                <form asp-action="DecreaseProductQuantity" method="post">
                                    <input type="hidden" name="orderProductId" value="@orderProduct.Id" />
                                    <button type="submit" class="cart-quantity-minus" @(orderProduct.Quantity <= 1 ? "disabled" : "")>-</button>
                                </form>
                                <span class="cart-quantity-value">@orderProduct.Quantity</span>
                                <form asp-action="IncreaseProductQuantity" method="post">
                                    <input type="hidden" name="orderProductId" value="@orderProduct.Id" />
                                    <button type="submit" class="cart-quantity-plus" 
                                         @(products.First(p => p.Id == orderProduct.ProductId).StockQuantity <= orderProduct.Quantity ? "disabled" : "")>+</button>
                                </form>
                            </td>
                            <td class="row-total tar">
                                <span class ="@(order.CouponId != null && orderProduct.Price != orderProduct.PriceWithCoupon ? "strike" : "")">@orderProduct.Price</span>
                                <br />
                                @if (order.CouponId != null && orderProduct.Price != orderProduct.PriceWithCoupon)
                                {
                                <span>@orderProduct.PriceWithCoupon</span>
                                }
                                </td>
                        </tr>
                    }


                    
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4">&nbsp;</td>
                        <td class="cart-total tar">
                           <span  class = "@(order.CouponId != null && order.TotalAmount != order.TotalAmountWithCoupon ? "strike" : "")"> @order.TotalAmount</span>
                            @if (order.CouponId != null && order.TotalAmount != order.TotalAmountWithCoupon)
                            {
                                <br />
                                <span class="discountPercentage">- @order.Coupon.PercentageDiscount.ToString().Split('.')[0]%</span>
                                <br />
                                <span>@order.TotalAmountWithCoupon</span>
                            }                            
                            </td>
                    </tr>

                </tfoot>
            </table>
        </section>
        <!-- Would be great to do this with AJAX -->
                <section class="cart-coupon tar">

        <form asp-action="ApplyCoupon" method="post">
            <input type="text" name="couponCode" />
            <button type="submit">Applica coupon</button>
        </form>
        @if (order.CouponId != null)
        {   
       <div class="couponCode">
  <form asp-action="RemoveCoupon" method="post" class="couponForm">
    <button type="submit">
      <span class="couponText">@order.Coupon.Code</span>
      <span class="removeCoupon">X</span>
    </button>
  </form>
</div>
        } 
                </section>



        <section class="tar">
    <form asp-action="UserInfo" method="post">
         <button type="submit" class="button" 
                    @(order.OrderProducts == null || order.OrderProducts.Count == 0 ? "disabled" : "")>Procedi</button>
    </form>

</section>
    </div>
